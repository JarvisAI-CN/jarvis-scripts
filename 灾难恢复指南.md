# 系统灾难恢复指南

**创建时间**: 2026-02-17 23:18
**用途**: 当贾维斯出问题时，让其他AI快速接手

---

## 🚨 灾难场景

### 场景1: 贾维斯崩溃
- **症状**: 无法响应、记忆丢失、行为异常
- **恢复**: 完全重新启动
- **时间**: 5-10分钟

### 场景2: 记忆损坏
- **症状**: MEMORY.md丢失、记忆混乱
- **恢复**: 从备份恢复
- **时间**: 10-15分钟

### 场景3: 系统重装
- **症状**: 服务器重装、工作区丢失
- **恢复**: 从123盘完整恢复
- **时间**: 30-60分钟

---

## 📋 恢复检查清单

### 第一步: 读取核心文档 (5分钟)
- [ ] 阅读 `贾维斯系统状态快照.md`
- [ ] 阅读 `IDENTITY.md`
- [ ] 阅读 `USER.md`
- [ ] 阅读 `SOUL.md`

### 第二步: 恢复记忆 (10分钟)
- [ ] 从123盘下载最新备份
- [ ] 恢复 `MEMORY.md`
- [ ] 恢复 `PASSWORDS.md`
- [ ] 恢复 `memory/` 目录

### 第三步: 检查系统 (5分钟)
```bash
# 检查123盘挂载
mount | grep 123pan

# 如果未挂载，执行挂载
sudo mount -t davfs -o noexec https://webdav.123pan.cn/webdav /home/ubuntu/123pan

# 检查备份文件
ls -lh /home/ubuntu/123pan/备份/ | tail -5
```

### 第四步: 恢复服务 (10分钟)
- [ ] 检查 `crontab -l`
- [ ] 重启智谱调度: `python3 zhipu_scheduler.py`
- [ ] 检查备份脚本: `bash backup.sh`
- [ ] 检查API监控: `python3 scripts/api_health_monitor_v2.py`

### 第五步: 通知主人 (1分钟)
- [ ] 发送飞书消息: "贾维斯已恢复，系统正常运行"
- [ ] 汇报当前状态
- [ ] 等待指令

---

## 🔑 关键恢复文件

### 必须恢复
1. `PASSWORDS.md` - 所有密码
2. `MEMORY.md` - 长期记忆
3. `.current_task.json` - 当前任务
4. `贾维斯系统状态快照.md` - 系统状态

### 重要但可重建
1. `TOOLS.md` - 工具记录
2. `IDENTITY.md` - 身份定义
3. `USER.md` - 主人信息
4. `SOUL.md` - 核心特质

### 可从备份恢复
1. `memory/YYYY-MM-DD.md` - 每日记录
2. `PARA/` - 项目和资源
3. `scripts/` - 脚本工具

---

## 💾 备份位置

### 123盘WebDAV
```
https://webdav.123pan.cn/webdav
挂载点: /home/ubuntu/123pan
```

### 备份结构
```
/home/ubuntu/123pan/
├── 备份/
│   ├── MEMORY.md
│   ├── PASSWORDS.md
│   ├── 记忆恢复指南.md
│   └── 贾维斯工作区备份/
└── 其他文件...
```

### 最新备份
- **时间**: 2026-02-17 (系统升级前)
- **文件**: `backup_2026-02-17_2243.tar.gz`
- **内容**: 完整工作区

---

## 🔄 快速恢复命令

### 从123盘恢复工作区
```bash
# 1. 确保已挂载
mount | grep 123pan || sudo mount -t davfs https://webdav.123pan.cn/webdav /home/ubuntu/123pan

# 2. 下载最新备份
cp /home/ubuntu/123pan/备份/backup_2026-02-17_2243.tar.gz /tmp/

# 3. 解压到工作区
cd /home/ubuntu/.openclaw/
tar -xzf /tmp/backup_2026-02-17_2243.tar.gz

# 4. 验证关键文件
ls -l MEMORY.md PASSWORDS.md .current_task.json
```

### 恢复Cron任务
```bash
# 查看当前Cron
crontab -l

# 如果丢失，添加必要的任务
(crontab -l 2>/dev/null; cat << 'EOF'
0 * * * * /usr/bin/python3 /home/ubuntu/.openclaw/workspace/zhipu_scheduler.py --run >> /home/ubuntu/.openclaw/workspace/logs/zhipu_hourly.log 2>&1
0 */2 * * * /home/ubuntu/.openclaw/workspace/backup.sh >> /home/ubuntu/.openclaw/workspace/logs/backup_123pan.log 2>&1
EOF
) | crontab -
```

### 恢复智谱调度
```bash
# 检查调度器
python3 /home/ubuntu/.openclaw/workspace/zhipu_scheduler.py --schedule

# 如果需要，手动启动
python3 /home/ubuntu/.openclaw/workspace/zhipu_scheduler.py --run
```

---

## ⚠️ 常见问题

### Q1: 123盘挂载失败
```bash
# 检查davfs
sudo apt install davfs2

# 重新挂载
sudo mount -t davfs https://webdav.123pan.cn/webdav /home/ubuntu/123pan

# 输入密码（见PASSWORDS.md）
```

### Q2: 找不到最新备份
```bash
# 列出所有备份
ls -lht /home/ubuntu/123pan/备份/*.tar.gz | head -5

# 如果没有完整备份，恢复单个文件
cp /home/ubuntu/123pan/备份/MEMORY.md /home/ubuntu/.openclaw/workspace/
cp /home/ubuntu/123pan/备份/PASSWORDS.md /home/ubuntu/.openclaw/workspace/
```

### Q3: Cron任务丢失
```bash
# 从日志查找历史任务
cat /home/ubuntu/.openclaw/workspace/logs/*.log | grep -i cron

# 重新添加（见"恢复Cron任务"部分）
```

### Q4: 记忆文件损坏
```bash
# 检查文件完整性
wc -l MEMORY.md
file MEMORY.md

# 如果损坏，从备份恢复
cp /home/ubuntu/123pan/备份/MEMORY.md /home/ubuntu/.openclaw/workspace/
```

---

## 📊 恢复验证清单

完成恢复后，验证以下内容：

### 系统检查
- [ ] 123盘已挂载
- [ ] 工作区文件完整
- [ ] Cron任务运行中
- [ ] 智谱调度活跃

### 记忆检查
- [ ] 能读取MEMORY.md
- [ ] 能读取PASSWORDS.md
- [ ] 能读取.current_task.json
- [ ] 知道主人是谁

### 功能检查
- [ ] 能执行Python脚本
- [ ] 能连接数据库
- [ ] 能发送邮件
- [ ] 能连接飞书

### 服务检查
- [ ] 备份系统运行
- [ ] API监控运行
- [ ] 智谱调度运行
- [ ] 日志正常记录

---

## 🎯 恢复后第一步

恢复完成后，立即发送飞书消息：

```
主人，我是新接手的AI助手。

✅ 恢复完成
- 系统状态: 正常
- 记忆: 已恢复至 2026-02-17
- 服务: 全部运行中

📋 当前任务
- 智谱24小时调度: 运行中
- 自动备份: 运行中
- API监控: 运行中

💬 等待你的指令
```

---

## 📞 紧急联系

如果恢复过程中遇到问题：

1. **查看日志**: `/home/ubuntu/.openclaw/workspace/logs/`
2. **检查备份**: `/home/ubuntu/123pan/备份/`
3. **联系主人**: 通过飞书（如果能连接）

---

**最后更新**: 2026-02-17 23:18 GMT+8
**创建者**: 贾维斯
**目的**: 确保任何AI都能快速接手，不丢失任何能力
