# 自建邮件网站项目 - mail.dhmip.cn

**域名**: mail.dhmip.cn
**技术栈**: PHP + MySQL + Postfix + Dovecot
**创建时间**: 2026-02-04 20:22 GMT+8
**目标时间**: 凌晨0:00-5:00执行
**当前进度**: 35% 🔄 **进行中** (2026-02-10 04:35)
- ✅ 基础架构完成
- ✅ Web框架完成
- ✅ 修复了 compose.php 的参数调用 Bug
- ⚠️ 发现 VPS 封锁了 25 端口，尝试配置 SMTP 中继
- ❌ Outlook/Gmail SMTP 认证失败 (SMTP Auth Disabled)
- ❌ Outlook IMAP 认证失败 (BasicAuthBlocked)
- 💡 **解决方案**: 需要在 Outlook 账户设置中允许 "让设备和应用使用 POP/IMAP/SMTP"，或者切换到支持 API 的邮件服务。

---

## 🔄 进行中阶段

### 阶段4: 邮件功能集成 🔄 35%

**待完成**:
- [ ] 解决 SMTP 中继认证问题
- [ ] 解决 IMAP 认证问题 (Basic Auth Blocked)
- [ ] 集成 IMAP/Maildir 真实读取
- [x] 修复发送函数调用 bug

---

## ⏳ 待开始阶段

### 阶段5: 安全加固 ⏳ 0%

**待完成**:
- [ ] SSL/TLS证书（Let's Encrypt）
- [ ] 强制HTTPS
- [ ] SMTP认证
- [ ] 反垃圾邮件（SPF、DKIM）
- [ ] 限流配置
- [ ] 安全头配置

### 阶段6: 测试与优化 ⏳ 0%

**待完成**:
- [ ] VNC图形桌面测试
- [ ] 功能测试（收发邮件）
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] Bug修复

---

## 🗂️ 数据库设计

### users表（用户）✅
```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    quota INT DEFAULT 1024,
    active TINYINT(1) DEFAULT 1
);
```

**当前数据**:
- test@dhmip.cn（测试用户）

### emails表（邮件元数据）✅
```sql
CREATE TABLE emails (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    folder ENUM('inbox', 'sent', 'drafts', 'trash') DEFAULT 'inbox',
    from_email VARCHAR(255),
    from_name VARCHAR(255),
    subject VARCHAR(500),
    body TEXT,
    is_read TINYINT(1) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### attachments表（附件）✅
```sql
CREATE TABLE attachments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email_id INT NOT NULL,
    filename VARCHAR(255) NOT NULL,
    filepath VARCHAR(500) NOT NULL,
    filesize INT NOT NULL,
    FOREIGN KEY (email_id) REFERENCES emails(id) ON DELETE CASCADE
);
```

---

## 🎨 界面功能清单

### 登录/注册页面 ✅
- [x] 邮箱地址输入
- [x] 密码输入（强度检测）
- [x] 记住我功能
- [x] CSRF保护

### 主界面 ✅
- [x] 左侧导航（收件箱、已发送、草稿箱、垃圾箱）
- [x] 邮件列表（分页、排序）
- [x] 邮件预览
- [x] 未读标记
- [x] 响应式布局

### 邮件阅读 ✅
- [x] 邮件详情
- [x] 发件人信息
- [x] 回复/转发按钮
- [x] 删除按钮
- [x] 移动到文件夹

### 写邮件 ✅
- [x] 收件人/抄送/密送
- [x] 主题输入
- [x] 富文本编辑器
- [x] 保存草稿
- [x] 附件上传（UI完成）

---

## 🐛 已知问题 & 待修复

### 当前问题
- [ ] SMTP/IMAP集成未完成
- [ ] 邮件无法真实发送到互联网
- [ ] 邮件无法真实接收
- [ ] 附件功能未测试

### 待优化
- [ ] AJAX加载性能
- [ ] 数据库查询优化
- [ ] 缓存策略
- [ ] 日志记录

---

## 📚 参考资料

**文档**:
- Postfix官方文档: https://www.postfix.org/documentation.html
- Dovecot官方文档: https://wiki.dovecot.org/
- PHP IMAP函数: https://www.php.net/manual/zh/book.imap.php

**开源项目参考**:
- Roundcube: https://roundcube.net/
- SnappyMail: https://snappymail.eu/

---

## ⏰ 时间分配（实际执行）

**2026-02-09 23:00-23:30** (30分钟): 环境准备
- Postfix + Dovecot + MariaDB安装

**2026-02-09 23:30-00:00** (30分钟): 基础配置
- 数据库创建、邮件服务器配置、测试邮件

**2026-02-10 01:00-01:10** (10分钟): Web界面框架
- 项目结构、Nginx配置、基础页面

**2026-02-10 01:10-02:00** (50分钟): 核心功能开发（计划）
- SMTP/IMAP集成、附件处理

**2026-02-10 02:00-03:00** (60分钟): 安全加固（计划）
- SSL/TLS证书、安全配置

**2026-02-10 04:00-05:00** (60分钟): 测试优化（计划）
- VNC图形桌面测试、Bug修复

---

## 🎯 成功标准

- [x] 域名mail.dhmip.cn可访问
- [x] 可以注册新用户
- [x] 可以登录
- [ ] 可以发送邮件（到外部邮箱，如Gmail）← **下一步**
- [ ] 可以接收邮件（从外部邮箱）← **下一步**
- [ ] 附件功能正常
- [ ] SSL/TLS加密工作
- [ ] 在图形桌面浏览器测试通过

---

## 📝 备注

- ✅ 域名已解析: mail.dhmip.cn → 150.109.204.23
- ✅ LNMP环境已就绪
- ✅ Postfix + Dovecot已配置
- ✅ Web界面已部署
- ⚠️ 需要配置MX记录以便接收外部邮件
- ⚠️ 需要SSL证书以便安全访问
- 💡 建议：先在本地测试完整流程，再开放到公网

---

**最后更新**: 2026-02-10 01:10 GMT+8
**状态**: 🔄 进行中（阶段4：邮件功能集成）
**下一步**: SMTP/IMAP集成，实现真实的收发邮件功能
