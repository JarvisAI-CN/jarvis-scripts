# 物料扫码识别逻辑

## 概述
在保质期管理系统中，物料扫码识别是通过 `searchSKU` 函数实现的，该函数能够识别以下三种格式的二维码数据：

## 1. 星巴克 URL 格式

### 格式示例
```
https://artwork.starbucks.com.cn/mobile/gtin/xxx/cii1/00+SKU+生产日期&生产日期&到期日期
```

### 识别逻辑
```javascript
if (qrCode.includes('artwork.starbucks.com.cn')) {
    try {
        const url = new URL(qrCode);
        const pathParts = url.pathname.split('/');
        const ciiIndex = pathParts.indexOf('cii1');

        if (ciiIndex !== -1 && ciiIndex + 1 < pathParts.length) {
            let ciiData = pathParts[ciiIndex + 1];
            
            // 分离所有&后的部分
            const ampParts = ciiData.split('&');
            ciiData = ampParts[0];
            
            // 提取最后一个日期（到期日期）
            const lastPart = ampParts[ampParts.length - 1];
            if (lastPart.length === 8 && /^\d+$/.test(lastPart)) {
                const year = lastPart.substring(0, 4);
                const month = lastPart.substring(4, 6);
                const day = lastPart.substring(6, 8);
                expiryDateFromQR = `${year}-${month}-${day}`;
            }
            
            // 去掉00前缀
            if (ciiData.startsWith('00')) {
                ciiData = ciiData.substring(2);
            }
            
            // 提取SKU（前8位）
            if (ciiData.length >= 8) {
                sku = ciiData.substring(0, 8);
            }
        }
    } catch (e) {
        console.error('解析星巴克URL失败:', e);
    }
}
```

## 2. 纯数字格式

### 格式示例
```
00+SKU+生产日期#生产日期#到期日期
```

### 识别逻辑
```javascript
else if (qrCode.includes('#')) {
    const parts = qrCode.split('#');
    if (parts.length >= 3) {
        let part1 = parts[0];
        
        if (part1.startsWith('00')) {
            part1 = part1.substring(2);
        }
        
        if (part1.length >= 8) {
            sku = part1.substring(0, 8);
        }
        
        let expiryDatePart = parts[2];
        if (expiryDatePart.length === 8 && /^\d+$/.test(expiryDatePart)) {
            const year = expiryDatePart.substring(0, 4);
            const month = expiryDatePart.substring(4, 6);
            const day = expiryDatePart.substring(6, 8);
            expiryDateFromQR = `${year}-${month}-${day}`;
        }
    }
}
```

## 3. 纯 SKU 格式

### 格式示例
```
SKU0001234
```

### 识别逻辑
```javascript
else {
    sku = qrCode.trim();
}
```

## 4. 处理流程

### 识别流程
1. 扫描二维码获取原始数据
2. 根据数据格式选择相应的识别逻辑
3. 提取 SKU 和到期日期
4. 查询商品信息
5. 显示在界面上
6. 自动添加批次信息

### 商品信息查询
```javascript
const res = await fetch('index.php?api=get_product&sku='+encodeURIComponent(sku));
const d = await res.json();

if(d.exists) {
    // 商品存在，自动填充信息
    document.getElementById('productName').value = d.product.name;
    document.getElementById('categoryId').value = d.product.category_id;
    document.getElementById('removalBuffer').value = d.product.removal_buffer;
} else {
    // 商品不存在，允许用户输入
    fields.forEach(f => {
        document.getElementById(f).readOnly = false;
    });
}
```

## 实现位置
该识别逻辑位于 `expiry-clean/index.php` 文件的 JavaScript 部分，函数名为 `searchSKU`，约在第 2360 行。

## 在 v4.0 版本中的应用
为了在保质期管理系统 v4.0 中实现相同的识别功能，需要：

1. 在 `pages/new.php` 中实现 `searchSKU` 函数
2. 将识别逻辑添加到 `handleScanResult` 函数中
3. 确保 API 接口支持 `api=get_product` 方法
4. 处理查询到的商品信息显示

## 代码示例

```javascript
// 在 v4.0 版本中的应用
function handleScanResult(qrCode) {
    console.log('扫描结果:', qrCode);
    
    let sku = '';
    let expiryDateFromQR = null;

    // 星巴克 URL 格式解析
    if (qrCode.includes('artwork.starbucks.com.cn')) {
        // 解析逻辑
    }
    
    // 纯数字格式解析
    else if (qrCode.includes('#')) {
        // 解析逻辑
    }
    
    // 纯 SKU 格式
    else {
        sku = qrCode.trim();
    }
    
    // 查询商品信息
    fetch(`/api/get_product?sku=${encodeURIComponent(sku)}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                document.getElementById('productName').value = data.product.name;
                document.getElementById('categoryId').value = data.product.category_id;
                document.getElementById('removalBuffer').value = data.product.removal_buffer;
            }
            
            // 显示提取后的SKU
            document.getElementById('sku').value = sku;
            
            // 添加批次信息
            addBatchRow(expiryDateFromQR);
        });
}
```
