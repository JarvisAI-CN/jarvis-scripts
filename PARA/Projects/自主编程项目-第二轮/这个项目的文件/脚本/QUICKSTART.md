# auto_maintain_v2.sh å¿«é€Ÿå‚è€ƒ

## ä¸€åˆ†é’Ÿä¸Šæ‰‹

```bash
# 1. è¿è¡Œæ£€æŸ¥
./auto_maintain_v2.sh

# 2. æŸ¥çœ‹ç»“æœ
tail -20 logs/auto_maintain_$(date +%Y%m%d).log

# 3. è®¾ç½®å®šæ—¶ä»»åŠ¡ (æ¯10åˆ†é’Ÿ)
crontab -e
# æ·»åŠ : */10 * * * * /path/to/auto_maintain_v2.sh
```

## å…³é”®å‘½ä»¤

### å¥åº·æ£€æŸ¥
| æœåŠ¡ | æ£€æŸ¥é¡¹ | ä¿®å¤ç­–ç•¥æ•° |
|-----|--------|----------|
| WebDAV | æŒ‚è½½+è¯»å†™ | 3 |
| VNC | ç«¯å£+è¿›ç¨‹ | 3 |
| å®å¡” | ç«¯å£+HTTP+è¿›ç¨‹ | 3 |
| Gateway | è¿è¡ŒçŠ¶æ€ | 3 |
| ç£ç›˜ | ä½¿ç”¨ç‡ | 3 |

### æ—¥å¿—ä½ç½®
- **ä¸»æ—¥å¿—**: `logs/auto_maintain_YYYYMMDD.log`
- **å‘Šè­¦æ—¥å¿—**: `logs/alerts.log`
- **é”æ–‡ä»¶**: `/tmp/auto_maintain_v2.lock`

### æ—¥å¿—çº§åˆ«
```
INFO     - æ­£å¸¸ä¿¡æ¯
SUCCESS  - æˆåŠŸæ“ä½œ âœ“
WARNING  - è­¦å‘Š (è‡ªåŠ¨ä¿®å¤ä¸­)
ERROR    - é”™è¯¯ (æ‰€æœ‰ç­–ç•¥å¤±è´¥)
ALERT    - éœ€è¦äººå·¥ä»‹å…¥ ğŸš¨
```

## ä¿®å¤æµç¨‹ç¤ºä¾‹

### WebDAV æ•…éšœ
```
ç­–ç•¥1: mount -a
   â†“ å¤±è´¥
ç­–ç•¥2: systemctl restart davfs2
   â†“ å¤±è´¥
ç­–ç•¥3: ä¿®å¤é…ç½®å¹¶æŒ‚è½½
```

### VNC æ•…éšœ
```
ç­–ç•¥1: vncserver -kill :1 && vncserver :1
   â†“ å¤±è´¥
ç­–ç•¥2: pkill -9 Xvnc && vncserver :1
   â†“ å¤±è´¥
ç­–ç•¥3: vncserver :2 (ä½¿ç”¨ä¸åŒç«¯å£)
```

### ç£ç›˜æ»¡ (>85%)
```
ç­–ç•¥1: åˆ é™¤7å¤©å‰çš„æ—¥å¿—
   â†“ ä»æ»¡
ç­–ç•¥2: æ¸…ç†apt/npm/pipç¼“å­˜
   â†“ ä»æ»¡
ç­–ç•¥3: å‘é€å‘Šè­¦ ğŸš¨
```

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è·³è¿‡æŸä¸ªæ£€æŸ¥?
A: ç¼–è¾‘ `maintenance_config.json`,è®¾ç½® `"enabled": false`

### Q: å¦‚ä½•ä¿®æ”¹ç£ç›˜é˜ˆå€¼?
A: ç¼–è¾‘é…ç½®: `"threshold_percent": 85`

### Q: æƒé™ä¸è¶³æ€ä¹ˆåŠ?
A: é…ç½®sudoersæˆ–ä½¿ç”¨rootè¿è¡Œ:
```bash
sudo ./auto_maintain_v2.sh
```

### Q: å¦‚ä½•æŸ¥çœ‹è¯¦ç»†é”™è¯¯?
A: æœç´¢æ—¥å¿—ä¸­çš„ERROR:
```bash
grep ERROR logs/auto_maintain_*.log
```

## é…ç½®ç¤ºä¾‹

```json
{
  "checks": {
    "webdav": {
      "enabled": true,
      "mount_point": "/home/ubuntu/123pan"
    },
    "vnc": {
      "enabled": true,
      "port": 5901
    }
  },
  "logging": {
    "level": "INFO"
  }
}
```

## é€€å‡ºç 

- `0` - æ‰€æœ‰æ£€æŸ¥é€šè¿‡
- `>0` - å¤±è´¥æ£€æŸ¥çš„æ•°é‡

## ç›‘æ§é›†æˆ

### æ·»åŠ åˆ°ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
./auto_maintain_v2.sh
if [ $? -gt 0 ]; then
    # å‘é€å‘Šè­¦
    echo "ç»´æŠ¤æ£€æŸ¥å¤±è´¥" | mail -s "Alert" admin@example.com
fi
```

### é£ä¹¦å‘Šè­¦
```bash
# åœ¨ fix_strategies.sh æœ«å°¾æ·»åŠ 
if [ ${#failed_checks[@]} -gt 0 ]; then
    curl -X POST "https://open.feishu.cn/..." \
         -d '{"msg_type":"text","content":{"text":"ç»´æŠ¤æ£€æŸ¥å¤±è´¥"}}'
fi
```

## æ€§èƒ½å‚è€ƒ

- **å•æ¬¡æ£€æŸ¥**: ~5-15ç§’
- **å†…å­˜å ç”¨**: <10MB
- **æ—¥å¿—å¢é•¿**: ~1MB/å¤©
- **CPUå ç”¨**: <5%

## æœ€ä½³å®è·µ

1. âœ… å®šæœŸæ£€æŸ¥æ—¥å¿— (æ¯å‘¨)
2. âœ… è®¾ç½®å®šæ—¶ä»»åŠ¡ (æ¯10-30åˆ†é’Ÿ)
3. âœ… ç›‘æ§ç£ç›˜ç©ºé—´ (å‘Šè­¦é˜ˆå€¼85%)
4. âœ… é…ç½®å‘Šè­¦é€šçŸ¥ (é£ä¹¦/é‚®ä»¶)
5. âœ… å®šæœŸæµ‹è¯•ä¿®å¤ç­–ç•¥ (æ¯æœˆ)

## ä¸‹ä¸€æ­¥

- [ ] é›†æˆé£ä¹¦å‘Šè­¦
- [ ] æ·»åŠ æ›´å¤šæ£€æŸ¥é¡¹
- [ ] å®ç°è‡ªæ„ˆç»Ÿè®¡
- [ ] Webç›‘æ§ç•Œé¢

## è·å–å¸®åŠ©

```bash
# æŸ¥çœ‹å®Œæ•´æ–‡æ¡£
cat README.md

# æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
cat TEST_REPORT.md

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/auto_maintain_$(date +%Y%m%d).log
```

---

**ç‰ˆæœ¬**: v2.0  
**æ›´æ–°**: 2026-02-13  
**ä½œè€…**: GLM-4.7
