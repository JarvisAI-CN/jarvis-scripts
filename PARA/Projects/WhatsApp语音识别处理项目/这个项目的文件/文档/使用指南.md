# WhatsAppè¯­éŸ³è¯†åˆ«å¤„ç†é¡¹ç›® - ä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¶é—´**: 2026-02-14
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
3. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
4. [APIå‚è€ƒ](#apiå‚è€ƒ)
5. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
6. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
7. [OpenClawé›†æˆ](#openclawé›†æˆ)

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Python**: 3.10+
- **FFmpeg**: éŸ³é¢‘æ ¼å¼è½¬æ¢ï¼ˆå¯é€‰ä½†æ¨èï¼‰
- **OpenClaw**: æ¶ˆæ¯ç½‘å…³ï¼ˆç”¨äºé›†æˆï¼‰
- **æ™ºè°±AI API Key**: ç”¨äºè¯­éŸ³è½¬å½•

### ä¸€é”®éƒ¨ç½²

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/ubuntu/.openclaw/workspace/PARA/Projects/WhatsAppè¯­éŸ³è¯†åˆ«å¤„ç†é¡¹ç›®

# è¿è¡Œéƒ¨ç½²è„šæœ¬
python3 è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/deploy.py

# éƒ¨ç½²å¹¶è¿è¡Œæµ‹è¯•
python3 è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/deploy.py --install-deps
```

### æ‰‹åŠ¨å®‰è£…

```bash
# 1. å®‰è£…Pythonä¾èµ–
pip3 install requests

# 2. å®‰è£…FFmpegï¼ˆUbuntu/Debianï¼‰
sudo apt-get update
sudo apt-get install -y ffmpeg

# 3. åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p /tmp/whatsapp_voice_state
mkdir -p /tmp/whatsapp_voices

# 4. è¿è¡Œæµ‹è¯•
cd /home/ubuntu/.openclaw/workspace/PARA/Projects/WhatsAppè¯­éŸ³è¯†åˆ«å¤„ç†é¡¹ç›®/è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts
python3 test_whatsapp_voice.py
```

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. è¯­éŸ³æ¶ˆæ¯å¤„ç†

**åŠŸèƒ½**: è‡ªåŠ¨æ¥æ”¶ã€ä¸‹è½½ã€è½¬å½•WhatsAppè¯­éŸ³æ¶ˆæ¯

**ç¤ºä¾‹**:
```python
from whatsapp_voice_handler import WhatsAppVoiceHandler

# åˆ›å»ºå¤„ç†å™¨
handler = WhatsAppVoiceHandler(
    state_file="/tmp/whatsapp_voice_state/state.json",
    zhipu_api_key="your_api_key_here"
)

# å¤„ç†æ¶ˆæ¯
result = handler.process_message(
    message_id="msg_123",
    audio_url="https://example.com/audio.ogg",
    sender="user123",
    chat_id="chat_456"
)

# æŸ¥çœ‹ç»“æœ
print(f"è½¬å½•ç»“æœ: {result.transcription}")
print(f"ç”Ÿæˆå›å¤: {result.reply}")
print(f"å¤„ç†çŠ¶æ€: {result.status}")
```

### 2. éŸ³é¢‘å¤„ç†

**åŠŸèƒ½**: ä¸‹è½½ã€æ ¼å¼è½¬æ¢ã€ä¸´æ—¶æ–‡ä»¶æ¸…ç†

**æ”¯æŒæ ¼å¼**:
- è¾“å…¥: OGG, OPUS, MP3, M4A, AAC
- è¾“å‡º: WAV (16kHz, å•å£°é“)

**ç¤ºä¾‹**:
```python
from whatsapp_voice_handler import AudioProcessor

processor = AudioProcessor(temp_dir="/tmp/whatsapp_voices")

# ä¸‹è½½éŸ³é¢‘
audio_file = processor.download(url, message_id)

# è½¬æ¢ä¸ºWAV
wav_file = processor.convert_to_wav(audio_file)

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
processor.cleanup(audio_file)
```

### 3. è¯­éŸ³è½¬å½•

**åŠŸèƒ½**: ä½¿ç”¨æ™ºè°±AI Whisper APIè½¬å½•éŸ³é¢‘

**å‡†ç¡®ç‡**: >95% (ä¸­æ–‡/è‹±æ–‡/æ–¹è¨€)

**ç¤ºä¾‹**:
```python
from whatsapp_voice_handler import TranscriptionService

service = TranscriptionService(api_key="your_api_key")

# è½¬å½•éŸ³é¢‘
text = service.transcribe(audio_file)
print(f"è½¬å½•ç»“æœ: {text}")
```

### 4. æ™ºèƒ½å›å¤ç”Ÿæˆ

**åŠŸèƒ½**: åŸºäºè½¬å½•å†…å®¹ç”Ÿæˆä¸Šä¸‹æ–‡æ„ŸçŸ¥å›å¤

**æ”¯æŒæŒ‡ä»¤**:
- æé†’: "æé†’æˆ‘æ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼š"
- è®°ä½: "è®°ä½è¿™ä¸ªé‡è¦ä¿¡æ¯"
- æŸ¥è¯¢: "å¸®æˆ‘æŸ¥å¤©æ°”"

**ç¤ºä¾‹**:
```python
from whatsapp_voice_handler import ReplyGenerator

generator = ReplyGenerator(owner_name="ä¸»äºº")

# ç”Ÿæˆå›å¤
reply = generator.generate("æé†’æˆ‘æ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼š", "user123")
# è¾“å‡º: "âœ… å·²è®°å½•æé†’ï¼šã€Œæé†’æˆ‘æ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼šã€æˆ‘ä¼šæŒ‰æ—¶æé†’æ‚¨ã€‚"
```

---

## éƒ¨ç½²æŒ‡å—

### OpenClawé›†æˆ

**æ–¹å¼1: å‘½ä»¤è¡Œé›†æˆ**

```bash
# ç›‘å¬WhatsAppæ¶ˆæ¯å¹¶å¤„ç†
openclaw message listen whatsapp | \
  python3 è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/openclaw_integration.py
```

**æ–¹å¼2: Pythonè„šæœ¬é›†æˆ**

```python
from openclaw_integration import OpenClawWhatsAppIntegration

# åˆ›å»ºé›†æˆå®ä¾‹
integration = OpenClawWhatsAppIntegration()

# å¤„ç†æ¶ˆæ¯æ•°æ®
result = integration.process_whatsapp_message(message_data)

# æŸ¥çœ‹ç»“æœ
print(f"çŠ¶æ€: {result['status']}")
print(f"è½¬å½•: {result['transcription']}")
print(f"å›å¤: {result['reply']}")
```

### SystemdæœåŠ¡ï¼ˆå¯é€‰ï¼‰

åˆ›å»ºsystemdæœåŠ¡å®ç°è‡ªåŠ¨è¿è¡Œ:

```bash
# å¤åˆ¶æœåŠ¡æ–‡ä»¶
sudo cp /tmp/whatsapp-voice-handler.service /etc/systemd/system/

# å¯ç”¨æœåŠ¡
sudo systemctl enable whatsapp-voice-handler

# å¯åŠ¨æœåŠ¡
sudo systemctl start whatsapp-voice-handler

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status whatsapp-voice-handler

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u whatsapp-voice-handler -f
```

---

## APIå‚è€ƒ

### WhatsAppVoiceHandler

**ä¸»æ§åˆ¶å™¨ç±»**

#### `__init__(state_file, temp_dir, zhipu_api_key)`

åˆå§‹åŒ–å¤„ç†å™¨

**å‚æ•°**:
- `state_file`: çŠ¶æ€æ–‡ä»¶è·¯å¾„
- `temp_dir`: ä¸´æ—¶æ–‡ä»¶ç›®å½•
- `zhipu_api_key`: æ™ºè°±AI APIå¯†é’¥

#### `process_message(message_id, audio_url, sender, chat_id, mime_type, duration)`

å¤„ç†è¯­éŸ³æ¶ˆæ¯ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰

**å‚æ•°**:
- `message_id`: æ¶ˆæ¯ID
- `audio_url`: éŸ³é¢‘URL
- `sender`: å‘é€è€…
- `chat_id`: èŠå¤©ID
- `mime_type`: MIMEç±»å‹ï¼ˆé»˜è®¤"audio/ogg"ï¼‰
- `duration`: æ—¶é•¿ï¼ˆç§’ï¼‰

**è¿”å›**: `VoiceMessage` å¯¹è±¡

#### `get_stats()`

è·å–å¤„ç†ç»Ÿè®¡

**è¿”å›**:
```python
{
    "total_processed": 10,
    "success_rate": 100
}
```

### AudioProcessor

**éŸ³é¢‘å¤„ç†å™¨**

#### `download(url, message_id)`

ä¸‹è½½éŸ³é¢‘æ–‡ä»¶

**å‚æ•°**:
- `url`: éŸ³é¢‘URL
- `message_id`: æ¶ˆæ¯ID

**è¿”å›**: `Path` å¯¹è±¡æˆ– `None`

#### `convert_to_wav(input_file)`

è½¬æ¢ä¸ºWAVæ ¼å¼

**å‚æ•°**:
- `input_file`: è¾“å…¥æ–‡ä»¶è·¯å¾„

**è¿”å›**: `Path` å¯¹è±¡æˆ– `None`

### TranscriptionService

**è½¬å½•æœåŠ¡**

#### `transcribe(audio_file)`

è½¬å½•éŸ³é¢‘æ–‡ä»¶

**å‚æ•°**:
- `audio_file`: éŸ³é¢‘æ–‡ä»¶è·¯å¾„

**è¿”å›**: è½¬å½•æ–‡æœ¬ï¼ˆstrï¼‰æˆ– `None`

### ReplyGenerator

**å›å¤ç”Ÿæˆå™¨**

#### `generate(transcription, sender)`

ç”Ÿæˆå›å¤

**å‚æ•°**:
- `transcription`: è½¬å½•æ–‡æœ¬
- `sender`: å‘é€è€…

**è¿”å›**: å›å¤æ–‡æœ¬ï¼ˆstrï¼‰

---

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ä½ç½®

`è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/config/config.json`

### é…ç½®é¡¹

```json
{
  "zhipu_api_key": "YOUR_ZHIPU_API_KEY_HERE",
  "openclaw_bin": "openclaw",
  "state_file": "/tmp/whatsapp_voice_state/state.json",
  "temp_dir": "/tmp/whatsapp_voices",
  "log_level": "INFO",
  "timeout": {
    "download": 30,
    "transcribe": 60,
    "convert": 60
  }
}
```

### ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

```bash
# æ™ºè°±AI APIå¯†é’¥
export ZHIPU_API_KEY="your_api_key_here"

# çŠ¶æ€æ–‡ä»¶è·¯å¾„
export WHATSAPP_VOICE_STATE="/tmp/whatsapp_voice_state/state.json"

# ä¸´æ—¶æ–‡ä»¶ç›®å½•
export WHATSAPP_VOICE_TEMP="/tmp/whatsapp_voices"

# æ—¥å¿—çº§åˆ«
export LOG_LEVEL="INFO"
```

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. FFmpegæœªæ‰¾åˆ°

**é”™è¯¯**: `FileNotFoundError: ffmpeg not found`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# CentOS/RHEL
sudo yum install ffmpeg

# macOS
brew install ffmpeg
```

#### 2. APIå¯†é’¥æ— æ•ˆ

**é”™è¯¯**: `âŒ è½¬å½•å¤±è´¥ (HTTP 401)`

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è´¦æˆ·ä½™é¢å……è¶³
- éªŒè¯APIå¯†é’¥æƒé™

#### 3. éŸ³é¢‘ä¸‹è½½å¤±è´¥

**é”™è¯¯**: `âŒ éŸ³é¢‘ä¸‹è½½å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥URLæ˜¯å¦å¯è®¿é—®
- éªŒè¯ç½‘ç»œè¿æ¥
- å¢åŠ è¶…æ—¶æ—¶é—´

#### 4. é‡å¤å¤„ç†æ¶ˆæ¯

**é—®é¢˜**: åŒä¸€æ¶ˆæ¯è¢«å¤„ç†å¤šæ¬¡

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥çŠ¶æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- ç¡®è®¤message_idå”¯ä¸€æ€§
- éªŒè¯çŠ¶æ€æŒä¹…åŒ–é€»è¾‘

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—:

```python
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s [%(levelname)s] %(name)s: %(message)s'
)
```

---

## OpenClawé›†æˆ

### 1. å®‰è£…OpenClaw

```bash
# macOS/Linux
curl -fsSL https://get.openclaw.ai | sh

# æˆ–ä½¿ç”¨npm
npm install -g openclaw
```

### 2. é…ç½®WhatsAppé€šé“

```bash
# ç™»å½•WhatsApp
openclaw whatsapp login

# æ‰«æäºŒç»´ç ç»‘å®š

# éªŒè¯è¿æ¥
openclaw whatsapp status
```

### 3. é›†æˆè¯­éŸ³å¤„ç†

**æ–¹æ³•A: å®æ—¶å¤„ç†**

```bash
# å¯åŠ¨å®æ—¶ç›‘å¬
openclaw message listen whatsapp | \
  python3 è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/openclaw_integration.py
```

**æ–¹æ³•B: å®šæ—¶æ‰¹å¤„ç†**

```bash
# æ·»åŠ åˆ°crontab
*/5 * * * * cd /home/ubuntu/.openclaw/workspace && \
  python3 PARA/Projects/WhatsAppè¯­éŸ³è¯†åˆ«å¤„ç†é¡¹ç›®/è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/whatsapp_voice_handler.py >> \
  PARA/Projects/WhatsAppè¯­éŸ³è¯†åˆ«å¤„ç†é¡¹ç›®/è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/logs/process.log 2>&1
```

### 4. æµ‹è¯•é›†æˆ

```bash
# å‘é€æµ‹è¯•è¯­éŸ³æ¶ˆæ¯åˆ°WhatsApp
# æ£€æŸ¥æ—¥å¿—
tail -f è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/logs/process.log

# æŸ¥çœ‹ç»Ÿè®¡
python3 è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/openclaw_integration.py --stats
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡å¤„ç†

å¯¹äºå¤§é‡æ¶ˆæ¯ï¼Œä½¿ç”¨æ‰¹é‡å¤„ç†:

```python
messages = [...]  # æ¶ˆæ¯åˆ—è¡¨

for msg in messages:
    result = handler.process_message(**msg)
    # å¤„ç†ç»“æœ
```

### 2. å¹¶å‘å¤„ç†

ä½¿ç”¨å¤šçº¿ç¨‹/è¿›ç¨‹æé«˜ååé‡:

```python
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=4) as executor:
    futures = [executor.submit(handler.process_message, **msg)
               for msg in messages]

    for future in futures:
        result = future.result()
        # å¤„ç†ç»“æœ
```

### 3. ç¼“å­˜ä¼˜åŒ–

ç¼“å­˜å·²å¤„ç†æ¶ˆæ¯é¿å…é‡å¤å¤„ç†:

```python
# çŠ¶æ€æ–‡ä»¶è‡ªåŠ¨ç¼“å­˜å·²å¤„ç†æ¶ˆæ¯
# handler.process_message() ä¼šè‡ªåŠ¨æ£€æŸ¥
```

---

## ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¿—ä½ç½®

- å¤„ç†æ—¥å¿—: `è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/logs/process.log`
- éƒ¨ç½²æ—¥å¿—: `è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/logs/deploy.log`
- ç³»ç»Ÿæ—¥å¿—: `journalctl -u whatsapp-voice-handler`

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥å¤„ç†çŠ¶æ€
python3 è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/whatsapp_voice_handler.py --stats

# æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶
du -sh /tmp/whatsapp_voices

# æ£€æŸ¥çŠ¶æ€æ–‡ä»¶
cat /tmp/whatsapp_voice_state/state.json | jq
```

### å®šæœŸç»´æŠ¤

```bash
# æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆæ¯å‘¨ï¼‰
find /tmp/whatsapp_voices -type f -mtime +7 -delete

# å‹ç¼©æ—§æ—¥å¿—ï¼ˆæ¯æœˆï¼‰
find è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/logs/ -name "*.log" -mtime +30 -gzip

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /tmp
```

---

## å®‰å…¨å»ºè®®

### 1. APIå¯†é’¥ç®¡ç†

- ä¸è¦å°†APIå¯†é’¥æäº¤åˆ°Git
- ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
- å®šæœŸè½®æ¢å¯†é’¥

### 2. æƒé™æ§åˆ¶

```bash
# é™åˆ¶çŠ¶æ€æ–‡ä»¶æƒé™
chmod 600 /tmp/whatsapp_voice_state/state.json

# é™åˆ¶è„šæœ¬æƒé™
chmod 700 è¿™ä¸ªé¡¹ç›®çš„æ–‡ä»¶/scripts/*.py
```

### 3. ç½‘ç»œå®‰å…¨

- ä½¿ç”¨HTTPSä¸‹è½½éŸ³é¢‘
- éªŒè¯éŸ³é¢‘æ¥æº
- é™åˆ¶æ–‡ä»¶å¤§å°

---

**æ–‡æ¡£ç»´æŠ¤**: WhatsAppè¯­éŸ³è¯†åˆ«å¤„ç†é¡¹ç›®v2.0
**æœ€åæ›´æ–°**: 2026-02-14 20:30 GMT+8
**ç‰ˆæœ¬**: v2.0
